# ===================================================================
# PACS Extension Server - Rust Application (ë‹¨ì¼ ìŠ¤í…Œì´ì§€ ë¹Œë“œ & ì‹¤í–‰)
# ===================================================================
FROM rust:1.90-slim as builder

# -------------------------------------------------------------------
# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
# -------------------------------------------------------------------
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    libpq-dev \
    ca-certificates \
    curl \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# -------------------------------------------------------------------
# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
# -------------------------------------------------------------------
WORKDIR /app

# -------------------------------------------------------------------
# ì†ŒìŠ¤ ë³µì‚¬
# -------------------------------------------------------------------
COPY Cargo.toml Cargo.lock ./
COPY src ./src
COPY config ./config
COPY migrations ./migrations
COPY .sqlx ./.sqlx

# -------------------------------------------------------------------
# í™˜ê²½ë³€ìˆ˜
# -------------------------------------------------------------------
ENV SQLX_OFFLINE=true
ENV RUST_LOG=debug

# -------------------------------------------------------------------
# ë¹Œë“œ
# -------------------------------------------------------------------
RUN cargo build --release --verbose

FROM debian:trixie-slim

# ëŸ°íƒ€ì„ì— í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    pkg-config \
    libpq5 \
    libssl3 \    
    postgresql-client \    
    ca-certificates \
    curl \
    && rm -rf /var/lib/apt/lists/*

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

COPY --from=builder /app/target/release/pacs_server /app/pacs_server
COPY --from=builder /app/config ./config
COPY --from=builder /app/migrations ./migrations

COPY --from=builder /app/target ./taraget


# ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
RUN echo '#!/bin/bash\n\
echo "ğŸ”„ Running database migrations..."\n\
for file in migrations/*.sql; do\n\
    if [ -f "$file" ]; then\n\
        echo "ğŸ“„ Executing: $file"\n\
        psql "$DATABASE_URL" -f "$file" || {\n\
            echo "âŒ Migration failed: $file"\n\
            exit 1\n\
        }\n\
    fi\n\
done\n\
echo "âœ… All migrations completed successfully"\n\
echo "ğŸš€ Starting PACS Extension Server..."\n\
exec ./pacs_server' > /app/start.sh

RUN chmod +x /app/start.sh

# -------------------------------------------------------------------
# ì»¨í…Œì´ë„ˆ ì‹œì‘ ëª…ë ¹
# -------------------------------------------------------------------
# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
CMD ["/app/start.sh"]
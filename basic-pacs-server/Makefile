# Basic PACS Server Makefile

.PHONY: help build run test clean docker-build docker-run docker-stop lint format check

# ê¸°ë³¸ íƒ€ê²Ÿ
help: ## ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´ ëª©ë¡ì„ í‘œì‹œí•©ë‹ˆë‹¤
	@echo "ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'

# ë¹Œë“œ ê´€ë ¨
build: ## í”„ë¡œì íŠ¸ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤
	@echo "ğŸ”¨ Building project..."
	cargo build

build-release: ## ë¦´ë¦¬ì¦ˆ ëª¨ë“œë¡œ ë¹Œë“œí•©ë‹ˆë‹¤
	@echo "ğŸ”¨ Building project in release mode..."
	cargo build --release

# ì‹¤í–‰ ê´€ë ¨
run: ## ê°œë°œ ëª¨ë“œë¡œ ì„œë²„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸš€ Starting server in development mode..."
	RUN_MODE=development cargo run

run-release: ## ë¦´ë¦¬ì¦ˆ ëª¨ë“œë¡œ ì„œë²„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸš€ Starting server in release mode..."
	RUN_MODE=production cargo run --release

# í…ŒìŠ¤íŠ¸ ê´€ë ¨
test: ## ëª¨ë“  í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸ§ª Running tests..."
	cargo test

test-unit: ## ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸ§ª Running unit tests..."
	cargo test --lib

test-integration: ## í†µí•© í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸ§ª Running integration tests..."
	cargo test --test integration_tests

# ì½”ë“œ í’ˆì§ˆ ê´€ë ¨
lint: ## ì½”ë“œ ë¦°íŒ…ì„ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸ” Running linter..."
	cargo clippy -- -D warnings

format: ## ì½”ë“œ í¬ë§·íŒ…ì„ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸ¨ Formatting code..."
	cargo fmt

check: ## ì½”ë“œ ê²€ì‚¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤ (ë¹Œë“œ + ë¦°íŠ¸ + í…ŒìŠ¤íŠ¸)
	@echo "âœ… Running all checks..."
	cargo check
	cargo clippy -- -D warnings
	cargo test

# ì •ë¦¬ ê´€ë ¨
clean: ## ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ë¥¼ ì •ë¦¬í•©ë‹ˆë‹¤
	@echo "ğŸ§¹ Cleaning build artifacts..."
	cargo clean

# Docker ê´€ë ¨
docker-build: ## Docker ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤
	@echo "ğŸ³ Building Docker image..."
	docker build -t basic-pacs-server .

docker-run: ## Docker ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "ğŸ³ Running Docker container..."
	docker run -d -p 8080:8080 --name basic-pacs-server basic-pacs-server

docker-stop: ## Docker ì»¨í…Œì´ë„ˆë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤
	@echo "ğŸ³ Stopping Docker container..."
	docker stop basic-pacs-server || true
	docker rm basic-pacs-server || true

docker-logs: ## Docker ì»¨í…Œì´ë„ˆ ë¡œê·¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤
	@echo "ğŸ³ Showing Docker container logs..."
	docker logs -f basic-pacs-server

# Docker Compose ê´€ë ¨
compose-up: ## Docker Composeë¡œ ì„œë¹„ìŠ¤ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤
	@echo "ğŸ³ Starting services with Docker Compose..."
	docker-compose up -d

compose-down: ## Docker Compose ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤
	@echo "ğŸ³ Stopping services with Docker Compose..."
	docker-compose down

compose-logs: ## Docker Compose ë¡œê·¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤
	@echo "ğŸ³ Showing Docker Compose logs..."
	docker-compose logs -f

# ê°œë°œ ê´€ë ¨
dev: ## ê°œë°œ í™˜ê²½ì„ ì„¤ì •í•©ë‹ˆë‹¤
	@echo "ğŸ› ï¸ Setting up development environment..."
	@if [ ! -f .env ]; then cp env.example .env; echo "ğŸ“ Created .env file from template"; fi
	@echo "âœ… Development environment ready!"

# API í…ŒìŠ¤íŠ¸
test-api: ## API ì—”ë“œí¬ì¸íŠ¸ë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤
	@echo "ğŸŒ Testing API endpoints..."
	@echo "Testing health check..."
	@curl -s http://localhost:8080/health | jq . || echo "âŒ Health check failed"
	@echo "Testing server info..."
	@curl -s http://localhost:8080/info | jq . || echo "âŒ Server info failed"
	@echo "Testing API health check..."
	@curl -s http://localhost:8080/api/health | jq . || echo "âŒ API health check failed"
	@echo "Testing API server info..."
	@curl -s http://localhost:8080/api/info | jq . || echo "âŒ API server info failed"

# ì „ì²´ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
all: clean build test lint ## ì „ì²´ ë¹Œë“œ, í…ŒìŠ¤íŠ¸, ë¦°íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤
	@echo "âœ… All checks passed!"

# ê¸°ë³¸ íƒ€ê²Ÿ
.DEFAULT_GOAL := help

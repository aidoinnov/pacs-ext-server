# Makefile for Health Check Server

.PHONY: help build run test clean docker-build docker-run dev run-prod health deps check fmt clippy

# Default target
help:
	@echo "Available commands:"
	@echo "  build        - Build the application"
	@echo "  run          - Run the application"
	@echo "  test         - Run tests"
	@echo "  clean        - Clean build artifacts"
	@echo "  check        - Check code without building"
	@echo "  fmt          - Format code"
	@echo "  clippy       - Run clippy linter"
	@echo "  docker-build - Build Docker image"
	@echo "  docker-run   - Run with Docker Compose"
	@echo "  dev          - Run in development mode"
	@echo "  run-prod     - Run in production mode"
	@echo "  health       - Check server health"
	@echo "  deps         - Install dependencies"

# Build the application
build:
	@echo "ğŸ”¨ Building Health Check Server..."
	cargo build --release
	@echo "âœ… Build completed"

# Run the application
run:
	@echo "ğŸš€ Starting Health Check Server..."
	cargo run

# Run tests
test:
	@echo "ğŸ§ª Running tests..."
	cargo test
	@echo "âœ… Tests completed"

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	cargo clean
	@echo "âœ… Clean completed"

# Check code without building
check:
	@echo "ğŸ” Checking code..."
	cargo check
	@echo "âœ… Check completed"

# Format code
fmt:
	@echo "ğŸ¨ Formatting code..."
	cargo fmt
	@echo "âœ… Formatting completed"

# Run clippy linter
clippy:
	@echo "ğŸ” Running clippy..."
	cargo clippy -- -D warnings
	@echo "âœ… Clippy completed"

# Build Docker image
docker-build:
	@echo "ğŸ³ Building Docker image..."
	docker build -t health-check-server .
	@echo "âœ… Docker image built"

# Run with Docker Compose
docker-run:
	@echo "ğŸ³ Starting with Docker Compose..."
	docker-compose up --build

# Run in development mode
dev:
	@echo "ğŸ”§ Starting in development mode..."
	RUN_MODE=development cargo run

# Run in production mode
run-prod:
	@echo "ğŸš€ Starting in production mode..."
	RUN_MODE=production cargo run

# Check health
health:
	@echo "â¤ï¸  Checking server health..."
	@curl -f http://localhost:8080/health || echo "âŒ Server is not responding"

# Install dependencies
deps:
	@echo "ğŸ“¦ Installing dependencies..."
	cargo build
	@echo "âœ… Dependencies installed"

# Development workflow
dev-setup: deps fmt clippy test
	@echo "ğŸ”§ Development setup completed"

# Production build
prod-build: clean fmt clippy test build
	@echo "ğŸš€ Production build completed"

# Docker development
docker-dev:
	@echo "ğŸ³ Starting development with Docker Compose..."
	docker-compose --profile dev up --build

# Docker test
docker-test:
	@echo "ğŸ³ Running tests with Docker Compose..."
	docker-compose --profile test up --build --abort-on-container-exit

# Full CI pipeline
ci: clean fmt clippy test build
	@echo "âœ… CI pipeline completed"
